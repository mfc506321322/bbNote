# 微信公众号权限认证过程/步骤

> 王斌 2019.11.18

1. AppID(应用ID) 和  AppSecret(应用秘钥)  在微信微信公众号--**基本配置** 查看

![wx](../image/wx.png)

2. 微信授权流程图

   1. 注释1：获取code 代码

   2. ```javascript
      const host = window.location.origin + window.location.pathname;
      const redirect_uri = encodeURI(host)
      const wx_auth_url = `https://open.weixin.qq.com/connect/oauth2/authorize?appid=${appid}&redirect_uri=${redirect_uri}&response_type=code&scope=snsapi_base&state=${state}&connect_redirect=1#wechat_redirect`
      window.location.href = wx_auth_url
      ```

   3. 注释2：含code 的url

      ```javascript
      https://gzh.yunfuw.cn/?code=021jQoBb1IQWVw0YTsDb1PFyBb1jQoBg&state=
      ```

   4. 注释3：获取网页授权 access_token

      1. 通过code换取网页授权access_token

      ```javascript
      
      https://api.weixin.qq.com/sns/oauth2/access_token?appid=APPID&secret=SECRET&code=CODE&grant_type=authorization_code
      
      https请求方式: GET https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=APPID&secret=APPSECRET
      ```

      1. 返回格式为:

      ```javascript
      {
        "access_token":"ACCESS_TOKEN",//网页授权接口调用凭证,注意：此access_token与基础支持的access_token不同
        "expires_in":7200,
        "refresh_token":"REFRESH_TOKEN",
        "openid":"OPENID",
        "scope":"SCOPE" 
      }
      
      
      ```

      

   5. 注释4：获取openId

      ```javascript
      http请求方式: GET（请使用https协议）
      https://api.weixin.qq.com/cgi-bin/user/get?access_token=ACCESS_TOKEN&next_openid=NEXT_OPENID
      ```

      

```mermaid
sequenceDiagram
Title:微信授权时序图
	公众号->>后台:请求接口获取appId
	Note left of 公众号:步骤一：获取appId
	后台-->>公众号:返回appId
	公众号->>微信后台:location.href 跳转到 授权url，见注释1
	opt 用户授权
	微信后台->>微信后台:等待用户 确认授权
	公众号->>微信后台: 用户确认授权
	end
	Note left of 公众号:步骤二： 微信授权<br/>获取code
	微信后台-->>公众号:跳转含code的url，见注释2
	
	公众号->>后台:请求后台接口,参数appId、Code、secret
	Note left of 微信后台:1.见注释3
	后台->>微信后台:请求接口
	
	微信后台-->>后台:返回access_token、openId

	Note left of 公众号:步骤三：获取<br/>access_token、<br/>openId
	后台-->>公众号:返回access_token和openId
	
	
	
 
```

